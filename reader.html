<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Reading - MyWeb Books</title>

    <!-- EPUB.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

    <!-- Styles -->
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/modal.css">

    <style>
        /* ============================================
           RESET & BASE
           ============================================ */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: var(--font-ui);
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        /* ============================================
           TOOLBAR
           ============================================ */
        .reader-toolbar {
            height: var(--toolbar-height);
            background: #000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--space-4);
            border-bottom: 1px solid var(--border-subtle);
            position: relative;
            z-index: 100;
        }

        .toolbar-section {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .toolbar-center {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        /* Back Link */
        .back-link {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            color: var(--accent-primary);
            text-decoration: none;
            font-weight: var(--font-semibold);
            font-size: var(--text-sm);
            transition: color var(--transition-fast);
        }

        .back-link:hover {
            color: var(--accent-hover);
        }

        .back-link svg {
            width: 20px;
            height: 20px;
        }

        /* Book Title */
        .book-title {
            color: var(--text-primary);
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Toolbar Buttons */
        .toolbar-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .toolbar-btn:hover {
            background: var(--bg-hover);
            border-color: var(--border-strong);
        }

        .toolbar-btn:active {
            transform: scale(0.95);
        }

        .toolbar-btn.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .toolbar-btn svg {
            width: 18px;
            height: 18px;
        }

        .toolbar-btn.nav-btn {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .toolbar-btn.nav-btn:hover {
            background: var(--accent-hover);
            border-color: var(--accent-hover);
        }

        .toolbar-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Progress Indicator */
        .progress-indicator {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            color: var(--text-muted);
            font-size: var(--text-sm);
            min-width: 80px;
            justify-content: center;
        }

        /* ============================================
           READER CONTAINER
           ============================================ */
        .reader-container {
            height: calc(100vh - var(--toolbar-height));
            display: flex;
            position: relative;
            overflow: hidden;
        }

        /* ============================================
           EPUB VIEWER
           ============================================ */
        #epub-viewer {
            flex: 1;
            height: 100%;
            background: var(--reader-bg, #fff);
            overflow: hidden;
        }

        /* Apply reader theme */
        [data-theme="light"] #epub-viewer {
            background: #ffffff;
        }

        [data-theme="sepia"] #epub-viewer {
            background: #f4ecd8;
        }

        [data-theme="dark"] #epub-viewer {
            background: #1a1a2e;
        }

        /* ============================================
           SETTINGS PANEL
           ============================================ */
        .settings-panel {
            position: fixed;
            top: var(--toolbar-height);
            right: 0;
            width: var(--sidebar-width);
            height: calc(100vh - var(--toolbar-height));
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-subtle);
            padding: var(--space-6);
            transform: translateX(100%);
            transition: transform var(--transition-slow);
            z-index: 90;
            overflow-y: auto;
        }

        .settings-panel.open {
            transform: translateX(0);
        }

        .settings-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-6);
        }

        .settings-title {
            font-size: var(--text-lg);
            font-weight: var(--font-semibold);
        }

        .settings-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: var(--space-2);
            border-radius: var(--radius-md);
            transition: color var(--transition-fast);
        }

        .settings-close:hover {
            color: var(--text-primary);
        }

        .settings-close svg {
            width: 24px;
            height: 24px;
        }

        /* Settings Section */
        .settings-section {
            margin-bottom: var(--space-6);
        }

        .settings-label {
            display: block;
            font-size: var(--text-xs);
            font-weight: var(--font-medium);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--space-3);
        }

        /* Font Select */
        .font-select {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            padding-right: var(--space-10);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: var(--font-ui);
            font-size: var(--text-sm);
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236b7a8f' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
        }

        .font-select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .font-select option {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* Slider Control */
        .slider-control {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .slider-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: var(--text-lg);
            font-weight: var(--font-bold);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .slider-btn:hover {
            background: var(--bg-hover);
        }

        .slider-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .slider-value {
            flex: 1;
            text-align: center;
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            color: var(--text-secondary);
        }

        .slider-range {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
            outline: none;
        }

        .slider-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--accent-primary);
            border-radius: 50%;
            cursor: pointer;
            transition: transform var(--transition-fast);
        }

        .slider-range::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        /* Theme Buttons */
        .theme-buttons {
            display: flex;
            gap: var(--space-2);
        }

        .theme-btn {
            flex: 1;
            padding: var(--space-3);
            border-radius: var(--radius-md);
            border: 2px solid transparent;
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .theme-btn.theme-light {
            background: #fff;
            color: #1a1a1a;
        }

        .theme-btn.theme-sepia {
            background: #f4ecd8;
            color: #5b4636;
        }

        .theme-btn.theme-dark {
            background: #1a1a2e;
            color: #e8e8e8;
        }

        .theme-btn.active {
            border-color: var(--accent-primary);
        }

        /* ============================================
           LOADING & ERROR STATES
           ============================================ */
        .loading-overlay,
        .error-state {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-primary);
            z-index: 50;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--bg-tertiary);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: var(--space-4);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-muted);
            font-size: var(--text-sm);
        }

        .error-state h2 {
            color: var(--accent-primary);
            margin-bottom: var(--space-3);
        }

        .error-state p {
            color: var(--text-muted);
            margin-bottom: var(--space-5);
        }

        .error-state a {
            color: var(--accent-primary);
            text-decoration: none;
        }

        .error-state a:hover {
            text-decoration: underline;
        }

        /* ============================================
           LOGIN PROMPT
           ============================================ */
        .login-prompt {
            position: fixed;
            bottom: var(--space-4);
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: var(--space-4);
            padding: var(--space-3) var(--space-5);
            background: var(--bg-elevated);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            z-index: 80;
        }

        .login-prompt p {
            color: var(--text-secondary);
            font-size: var(--text-sm);
        }

        .login-prompt a {
            color: var(--accent-primary);
            font-weight: var(--font-semibold);
            text-decoration: none;
        }

        .login-prompt a:hover {
            text-decoration: underline;
        }

        .login-prompt-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: var(--space-1);
        }

        /* ============================================
           RESPONSIVE
           ============================================ */
        @media (max-width: 768px) {
            .reader-toolbar {
                height: 50px;
                padding: 0 var(--space-3);
            }

            .toolbar-center {
                position: static;
                transform: none;
            }

            .book-title,
            .back-link span {
                display: none;
            }

            .toolbar-btn {
                width: 36px;
                height: 36px;
            }

            .reader-container {
                height: calc(100vh - 50px);
            }

            .settings-panel {
                width: 100%;
                top: 50px;
                height: calc(100vh - 50px);
            }

            .login-prompt {
                bottom: 0;
                left: 0;
                right: 0;
                transform: none;
                border-radius: 0;
                justify-content: center;
            }
        }

        /* ============================================
           FULLSCREEN MODE
           ============================================ */
        body.fullscreen .reader-toolbar {
            display: none;
        }

        body.fullscreen .reader-container {
            height: 100vh;
        }

        body.fullscreen .settings-panel {
            top: 0;
            height: 100vh;
        }
    </style>
</head>
<body data-theme="light">
    <!-- Toolbar -->
    <nav class="reader-toolbar">
        <div class="toolbar-section">
            <a href="index.html" class="back-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                <span>Library</span>
            </a>
            <span class="book-title" id="book-title">Loading...</span>
        </div>

        <div class="toolbar-section toolbar-center">
            <button class="toolbar-btn nav-btn" id="prev-btn" title="Previous (Left Arrow)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M15 18l-6-6 6-6"/>
                </svg>
            </button>
            <span class="progress-indicator" id="progress">--%</span>
            <button class="toolbar-btn nav-btn" id="next-btn" title="Next (Right Arrow)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 18l6-6-6-6"/>
                </svg>
            </button>
        </div>

        <div class="toolbar-section">
            <button class="toolbar-btn" id="favorite-btn" title="Favorite">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                </svg>
            </button>
            <button class="toolbar-btn" id="settings-btn" title="Settings">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
            </button>
            <button class="toolbar-btn" id="fullscreen-btn" title="Fullscreen (F)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                </svg>
            </button>
        </div>
    </nav>

    <!-- Reader -->
    <main class="reader-container" id="reader-container">
        <div class="loading-overlay" id="loading">
            <div class="loading-spinner"></div>
            <p class="loading-text">Loading book...</p>
        </div>
        <div id="epub-viewer"></div>
    </main>

    <!-- Settings Panel -->
    <aside class="settings-panel" id="settings-panel">
        <div class="settings-header">
            <h3 class="settings-title">Reading Settings</h3>
            <button class="settings-close" id="settings-close">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <!-- Font Family -->
        <div class="settings-section">
            <label class="settings-label">Font Family</label>
            <select class="font-select" id="font-family">
                <option value="Merriweather">Merriweather</option>
                <option value="Libre Baskerville">Libre Baskerville</option>
                <option value="Spectral">Spectral</option>
                <option value="Lora">Lora</option>
                <option value="Georgia">Georgia</option>
                <option value="Inter">Inter (Sans)</option>
                <option value="system-ui">System Default</option>
            </select>
        </div>

        <!-- Font Size -->
        <div class="settings-section">
            <label class="settings-label">Font Size</label>
            <div class="slider-control">
                <button class="slider-btn" id="font-decrease">−</button>
                <span class="slider-value" id="font-size-value">18px</span>
                <button class="slider-btn" id="font-increase">+</button>
            </div>
        </div>

        <!-- Line Height -->
        <div class="settings-section">
            <label class="settings-label">Line Height</label>
            <div class="slider-control">
                <input type="range" class="slider-range" id="line-height"
                       min="1.2" max="2.2" step="0.1" value="1.6">
                <span class="slider-value" id="line-height-value">1.6</span>
            </div>
        </div>

        <!-- Theme -->
        <div class="settings-section">
            <label class="settings-label">Theme</label>
            <div class="theme-buttons">
                <button class="theme-btn theme-light active" data-theme="light">Light</button>
                <button class="theme-btn theme-sepia" data-theme="sepia">Sepia</button>
                <button class="theme-btn theme-dark" data-theme="dark">Dark</button>
            </div>
        </div>
    </aside>

    <!-- Login Prompt -->
    <div class="login-prompt" id="login-prompt" style="display: none;">
        <p>Log in to save your progress</p>
        <a href="login.html" id="login-link">Log In</a>
        <button class="login-prompt-close" id="login-prompt-close">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
        </button>
    </div>

    <script src="js/api.js"></script>
    <script>
    // ============================================
    // READER APPLICATION
    // ============================================

    const Reader = {
        // State
        book: null,
        rendition: null,
        bookId: null,
        bookSlug: '',
        bookTitle: '',
        isLoggedIn: false,
        currentLocation: null,

        // Settings
        settings: {
            fontFamily: 'Merriweather',
            fontSize: 18,
            lineHeight: 1.6,
            theme: 'light'
        },

        // DOM Elements
        elements: {},

        // ============================================
        // INITIALIZATION
        // ============================================

        async init() {
            this.cacheElements();
            this.loadSettings();
            this.parseUrl();

            if (!this.bookSlug) {
                this.showError('No book selected', 'Please select a book from the library.');
                return;
            }

            this.setupEventListeners();
            await this.checkAuth();
            await this.loadBook();
        },

        cacheElements() {
            this.elements = {
                viewer: document.getElementById('epub-viewer'),
                loading: document.getElementById('loading'),
                bookTitle: document.getElementById('book-title'),
                progress: document.getElementById('progress'),
                prevBtn: document.getElementById('prev-btn'),
                nextBtn: document.getElementById('next-btn'),
                settingsBtn: document.getElementById('settings-btn'),
                settingsPanel: document.getElementById('settings-panel'),
                settingsClose: document.getElementById('settings-close'),
                fullscreenBtn: document.getElementById('fullscreen-btn'),
                favoriteBtn: document.getElementById('favorite-btn'),
                loginPrompt: document.getElementById('login-prompt'),
                fontFamily: document.getElementById('font-family'),
                fontDecrease: document.getElementById('font-decrease'),
                fontIncrease: document.getElementById('font-increase'),
                fontSizeValue: document.getElementById('font-size-value'),
                lineHeight: document.getElementById('line-height'),
                lineHeightValue: document.getElementById('line-height-value')
            };
        },

        parseUrl() {
            const params = new URLSearchParams(window.location.search);
            this.bookId = params.get('id');
            this.bookSlug = params.get('slug') || params.get('book') || '';
            this.bookTitle = decodeURIComponent(params.get('title') || 'Book');

            document.title = `${this.bookTitle} - MyWeb Books`;
            this.elements.bookTitle.textContent = this.bookTitle;
        },

        // ============================================
        // SETTINGS
        // ============================================

        loadSettings() {
            try {
                const saved = localStorage.getItem('myweb_reader_settings');
                if (saved) {
                    this.settings = { ...this.settings, ...JSON.parse(saved) };
                }
            } catch (e) {}

            // Apply to UI
            this.elements.fontFamily.value = this.settings.fontFamily;
            this.elements.fontSizeValue.textContent = `${this.settings.fontSize}px`;
            this.elements.lineHeight.value = this.settings.lineHeight;
            this.elements.lineHeightValue.textContent = this.settings.lineHeight;

            // Apply theme
            document.body.dataset.theme = this.settings.theme;
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.theme === this.settings.theme);
            });
        },

        saveSettings() {
            localStorage.setItem('myweb_reader_settings', JSON.stringify(this.settings));

            // Also save to API if logged in
            if (this.isLoggedIn && window.API) {
                API.updateProfile({
                    preferences: { readerSettings: this.settings }
                }).catch(() => {});
            }
        },

        applySettings() {
            if (!this.rendition) return;

            const themes = this.rendition.themes;

            // Register custom theme with all settings
            const themeColors = {
                light: { bg: '#ffffff', text: '#1a1a1a' },
                sepia: { bg: '#f4ecd8', text: '#5b4636' },
                dark: { bg: '#1a1a2e', text: '#e0e0e0' }
            };

            const colors = themeColors[this.settings.theme];

            themes.register('custom', {
                body: {
                    'font-family': `"${this.settings.fontFamily}", Georgia, serif !important`,
                    'font-size': `${this.settings.fontSize}px !important`,
                    'line-height': `${this.settings.lineHeight} !important`,
                    'background': `${colors.bg} !important`,
                    'color': `${colors.text} !important`,
                    'padding': '20px 40px !important',
                    'max-width': '800px !important',
                    'margin': '0 auto !important'
                },
                'p, div, span': {
                    'font-family': `"${this.settings.fontFamily}", Georgia, serif !important`,
                    'line-height': `${this.settings.lineHeight} !important`
                },
                'img': {
                    'max-width': '100% !important',
                    'height': 'auto !important',
                    'display': 'block !important',
                    'margin': '0 auto !important'
                }
            });

            themes.select('custom');

            // Update body theme
            document.body.dataset.theme = this.settings.theme;
        },

        // ============================================
        // AUTH
        // ============================================

        async checkAuth() {
            try {
                if (window.API) {
                    const user = await API.getCurrentUser();
                    this.isLoggedIn = !!user;
                }
            } catch (e) {
                this.isLoggedIn = false;
            }

            if (!this.isLoggedIn) {
                this.elements.loginPrompt.style.display = 'flex';
                document.getElementById('login-link').href =
                    `login.html?redirect=${encodeURIComponent(window.location.href)}`;
            }
        },

        // ============================================
        // BOOK LOADING
        // ============================================

        async loadBook() {
            try {
                const epubPath = `books/${this.bookSlug}.epub`;

                // Create book
                this.book = ePub(epubPath);

                // Create rendition
                this.rendition = this.book.renderTo(this.elements.viewer, {
                    width: '100%',
                    height: '100%',
                    spread: 'none',
                    flow: 'paginated',
                    manager: 'continuous'
                });

                // Apply settings before displaying
                this.applySettings();

                // Get saved position
                let startLocation = null;

                // Try API first
                if (this.isLoggedIn && this.bookId && window.API) {
                    try {
                        const progress = await API.getProgress(this.bookId);
                        if (progress.lastCfi) {
                            startLocation = progress.lastCfi;
                        }
                    } catch (e) {}
                }

                // Fallback to localStorage
                if (!startLocation) {
                    startLocation = localStorage.getItem(`myweb_cfi_${this.bookSlug}`);
                }

                // Display book
                await this.rendition.display(startLocation || undefined);

                // Hide loading
                this.elements.loading.style.display = 'none';

                // Generate locations for progress tracking
                this.book.ready.then(() => {
                    return this.book.locations.generate(1024);
                }).then(() => {
                    this.updateProgress();
                });

                // Location change handler
                this.rendition.on('relocated', (location) => {
                    this.currentLocation = location;
                    this.updateProgress();
                    this.saveProgress();
                });

                // Re-apply settings after each render
                this.rendition.on('rendered', () => {
                    this.applySettings();
                });

                // Check favorite status
                this.checkFavorite();

            } catch (error) {
                console.error('Failed to load book:', error);
                this.showError('Failed to load book', 'The book file may be missing or corrupted.');
            }
        },

        // ============================================
        // NAVIGATION
        // ============================================

        prevPage() {
            if (this.rendition) {
                this.rendition.prev();
            }
        },

        nextPage() {
            if (this.rendition) {
                this.rendition.next();
            }
        },

        updateProgress() {
            if (!this.book || !this.currentLocation) {
                this.elements.progress.textContent = '--%';
                return;
            }

            try {
                if (this.book.locations.length()) {
                    const current = this.book.locations.locationFromCfi(this.currentLocation.start.cfi);
                    const total = this.book.locations.length();
                    const percent = Math.round((current / total) * 100);
                    this.elements.progress.textContent = `${percent}%`;
                }
            } catch (e) {
                this.elements.progress.textContent = '--%';
            }
        },

        // ============================================
        // PROGRESS SAVING
        // ============================================

        _saveTimeout: null,

        saveProgress() {
            if (!this.currentLocation) return;

            // Debounce
            clearTimeout(this._saveTimeout);
            this._saveTimeout = setTimeout(() => {
                const cfi = this.currentLocation.start.cfi;

                // Always save to localStorage
                localStorage.setItem(`myweb_cfi_${this.bookSlug}`, cfi);

                // Save to API if logged in
                if (this.isLoggedIn && this.bookId && window.API) {
                    const percent = this.book.locations.length()
                        ? Math.round((this.book.locations.locationFromCfi(cfi) / this.book.locations.length()) * 100)
                        : 0;

                    API.updateProgress(this.bookId, {
                        lastCfi: cfi,
                        percentage: percent
                    }).catch(() => {});
                }
            }, 1000);
        },

        // ============================================
        // FAVORITES
        // ============================================

        async checkFavorite() {
            if (!this.isLoggedIn || !this.bookId || !window.API) return;

            try {
                const book = await API.getBook(this.bookId);
                this.updateFavoriteButton(book.isFavorite);
            } catch (e) {}
        },

        async toggleFavorite() {
            if (!this.isLoggedIn) {
                window.location.href = `login.html?redirect=${encodeURIComponent(window.location.href)}`;
                return;
            }

            if (!this.bookId || !window.API) return;

            try {
                const result = await API.toggleFavorite(this.bookId);
                this.updateFavoriteButton(result.isFavorite);
            } catch (e) {
                console.error('Failed to toggle favorite:', e);
            }
        },

        updateFavoriteButton(isFavorite) {
            const btn = this.elements.favoriteBtn;
            const svg = btn.querySelector('svg');

            if (isFavorite) {
                svg.setAttribute('fill', 'var(--accent-primary)');
                btn.classList.add('active');
            } else {
                svg.setAttribute('fill', 'none');
                btn.classList.remove('active');
            }
        },

        // ============================================
        // FULLSCREEN
        // ============================================

        toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().then(() => {
                    document.body.classList.add('fullscreen');
                }).catch(() => {});
            } else {
                document.exitFullscreen().then(() => {
                    document.body.classList.remove('fullscreen');
                }).catch(() => {});
            }
        },

        // ============================================
        // SETTINGS PANEL
        // ============================================

        toggleSettings() {
            this.elements.settingsPanel.classList.toggle('open');
        },

        closeSettings() {
            this.elements.settingsPanel.classList.remove('open');
        },

        // ============================================
        // ERROR HANDLING
        // ============================================

        showError(title, message) {
            this.elements.loading.remove();
            this.elements.viewer.innerHTML = `
                <div class="error-state">
                    <h2>${title}</h2>
                    <p>${message}</p>
                    <a href="index.html">← Return to Library</a>
                </div>
            `;
        },

        // ============================================
        // EVENT LISTENERS
        // ============================================

        setupEventListeners() {
            // Navigation
            this.elements.prevBtn.addEventListener('click', () => this.prevPage());
            this.elements.nextBtn.addEventListener('click', () => this.nextPage());

            // Settings panel
            this.elements.settingsBtn.addEventListener('click', () => this.toggleSettings());
            this.elements.settingsClose.addEventListener('click', () => this.closeSettings());

            // Close settings on outside click
            document.addEventListener('click', (e) => {
                if (!this.elements.settingsPanel.contains(e.target) &&
                    !this.elements.settingsBtn.contains(e.target) &&
                    this.elements.settingsPanel.classList.contains('open')) {
                    this.closeSettings();
                }
            });

            // Fullscreen
            this.elements.fullscreenBtn.addEventListener('click', () => this.toggleFullscreen());
            document.addEventListener('fullscreenchange', () => {
                if (!document.fullscreenElement) {
                    document.body.classList.remove('fullscreen');
                }
            });

            // Favorite
            this.elements.favoriteBtn.addEventListener('click', () => this.toggleFavorite());

            // Login prompt close
            document.getElementById('login-prompt-close')?.addEventListener('click', () => {
                this.elements.loginPrompt.style.display = 'none';
            });

            // Font family
            this.elements.fontFamily.addEventListener('change', (e) => {
                this.settings.fontFamily = e.target.value;
                this.applySettings();
                this.saveSettings();
            });

            // Font size
            this.elements.fontDecrease.addEventListener('click', () => {
                if (this.settings.fontSize > 12) {
                    this.settings.fontSize -= 2;
                    this.elements.fontSizeValue.textContent = `${this.settings.fontSize}px`;
                    this.applySettings();
                    this.saveSettings();
                }
            });

            this.elements.fontIncrease.addEventListener('click', () => {
                if (this.settings.fontSize < 32) {
                    this.settings.fontSize += 2;
                    this.elements.fontSizeValue.textContent = `${this.settings.fontSize}px`;
                    this.applySettings();
                    this.saveSettings();
                }
            });

            // Line height
            this.elements.lineHeight.addEventListener('input', (e) => {
                this.settings.lineHeight = parseFloat(e.target.value);
                this.elements.lineHeightValue.textContent = this.settings.lineHeight.toFixed(1);
                this.applySettings();
                this.saveSettings();
            });

            // Theme buttons
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    this.settings.theme = btn.dataset.theme;
                    this.applySettings();
                    this.saveSettings();
                });
            });

            // Keyboard navigation
            document.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }

                switch (e.key) {
                    case 'ArrowLeft':
                    case 'PageUp':
                        e.preventDefault();
                        this.prevPage();
                        break;
                    case 'ArrowRight':
                    case 'PageDown':
                    case ' ':
                        e.preventDefault();
                        this.nextPage();
                        break;
                    case 'f':
                    case 'F':
                        if (!e.ctrlKey && !e.metaKey) {
                            e.preventDefault();
                            this.toggleFullscreen();
                        }
                        break;
                    case 'Escape':
                        this.closeSettings();
                        break;
                }
            });

            // Touch swipe
            let touchStartX = 0;
            this.elements.viewer.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            }, { passive: true });

            this.elements.viewer.addEventListener('touchend', (e) => {
                const touchEndX = e.changedTouches[0].screenX;
                const diff = touchStartX - touchEndX;

                if (Math.abs(diff) > 50) {
                    if (diff > 0) {
                        this.nextPage();
                    } else {
                        this.prevPage();
                    }
                }
            }, { passive: true });
        }
    };

    // Initialize reader
    Reader.init();
    </script>
</body>
</html>
